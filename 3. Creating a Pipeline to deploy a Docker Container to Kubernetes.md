# Jenkins Pipeline: Deploying a Docker Container to Kubernetes

## Overview
This pipeline demonstrates how to deploy a Docker container to a Kubernetes cluster using Jenkins with `kubectl and docker`-enabled agents.

## Prerequisites
- **Jenkins ServiceAccount**: Must have permissions to create Kubernetes resources.
- **Docker Repository**: Functional Dockerfile and application structure.
- **Cluster Access**: Jenkins must have:
  - Access to the Kubernetes cluster
  - `kubectl` installed on agents (via custom image)
  - Docker installed on agents (via custom image)

---

## Step 1: Create Custom Jenkins Agent with kubectl
Instead of modifying the Jenkins controller, we create a custom agent image:

### Dockerfile
```dockerfile
FROM jenkins/inbound-agent:latest

# Create Dockerfile with kubectl and docker installed

``
FROM jenkins/inbound-agent:latest

USER root

# Install dependencies and Docker CLI
RUN apt-get update && \
    apt-get install -y \
      apt-transport-https \
      ca-certificates \
      curl \
      gnupg2 \
      lsb-release && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" \
      > /etc/apt/sources.list.d/docker.list && \
    apt-get update && \
    apt-get install -y docker-ce-cli

# Install kubectl (fixed version)
RUN curl -LO https://dl.k8s.io/release/v1.28.4/bin/linux/amd64/kubectl && \
    install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl && \
    rm kubectl && \
    kubectl version --client

USER jenkins
```

# Build and push

docker build -t danielarcoguasch/jenkins-agent-kubectl:latest .
docker push danielarcoguasch/jenkins-agent-kubectl:latest


## Step 2: Configure Kubernetes Pod Template in Jenkins

Navigate to Manage Jenkins → Configure Clouds → Kubernetes Cloud Details.

- Add a new Pod Template:

**Name**: docker-kubectl-agent
**Labels**: docker-kubectl-agent
**Add Container Template**:
**Name**: custom-agent
**Docker Image**: danielarcoguasch/jenkins-agent-docker-kubectl:latest
**Working Directory**: /home/jenkins/agent


## Step 3: Pipeline example to test if it running right

```
pipeline {
    agent {
        kubernetes {
            inheritFrom 'docker-kubectl-agent'
            defaultContainer 'custom-agent'
        }
    }
    stages {
        stage('Check Docker and Kubectl') {
            steps {
                container('custom-agent') {
                    sh '''
                      docker --version
                      kubectl version --client --short
                    '''
                }
            }
        }
    }
}

```


## Step 4: Checking permissions of service account in jenkins namespace


## Step 5: Granding permissions to service account

```
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jenkins-agents-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin  # O uno más restrictivo si quieres
subjects:
- kind: ServiceAccount
  name: default         # Aquí va el ServiceAccount
  namespace: jenkins    # Aquí va el namespace donde está Jenkins
```

```
kubectl apply -f jenkins-rbac.yaml
```

## Step X: Deploying a container in kubernetes cluster with a image on a repository of github

